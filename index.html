<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Speed Pro - Live News Edition</title>
    <link rel="icon" type="image/jpg" href="icon.jpg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ORIGINAL STYLES PRESERVED --- */
        .gradient-border-wrapper {
            position: relative;
            display: inline-block;
            padding: 5px;
            border-radius: 9999px;
            background: transparent;
            overflow: hidden;
        }

        .border-wrapper {
            position: relative;
            display: flex;
            padding: 3px;
            border-radius: 10px;
            background: transparent;
            overflow: hidden;
            width:100%;
        }

        .gradient-border-wrapper::before {
            content: "";
            position: absolute;
            right: -17px;
            top: -38px;
            insert: -50%;
            width: 150px;
            height: 150px;
            background: conic-gradient(
                #4285f4,
                #ea4335,
                #fbbc05,
                #34a853,
                #4285f4
            );
            animation: google-ring-spin 3s linear infinite;
        }

        .border-wrapper::before {
            content: "";
            position: absolute;
            right: -15%;
            top: -470px;
            insert: -50%;
            width: 130%;
            height: 700%;
            background: conic-gradient(
                #4285f4,
                #ea4335,
                #fbbc05,
                #34a853,
                #4285f4
            );
            animation: google-ring-spin 3s linear infinite;
        }

        .gradient-border-wrapper .inner-button {
            position: relative;
            z-index: 1;
            border: none;
            border-radius: 999px;
            padding: 10px 26px;
            background: #111;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }

        @keyframes google-ring-spin {
            0%    { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .border-wrapper .inner-button {
            position: relative;
            z-index: 1;
            border: none;
            border-radius: 10px;
            padding: 60px;
            background: #D1FFFF;
            color: black;
            font-size: 1.4em;
            cursor: pointer;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #424242;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .glow header {
            width: 96%;
            z-index: 2;
            text-align: center;
            border-radius: 12px;
            padding: 20px 0;
            background-color: #007bff;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 { margin: 0; font-weight: 600; }

        .glow {
            position: relative;
            display: inline-block;
            padding: 5px;
            border-radius: 9999px;
            background: transparent;
            overflow: hidden;
        }

        .glow::before {
            content: "";
            position: absolute;
            content-position: center;
            align-item: center;
            insert: -50%;
            width: calc(hypot(100vh, 100vh) + 900px);
            aspect-ratio:1/1;
            background: conic-gradient(
                #4285f4,
                #ea4335,
                #fbbc05,
                #34a853,
                #4285f4
            );
            animation: google-ring-spin 3s linear infinite;
        }
        .glow {
            display: flex;
            flex-direction: column;
            width: 100%;
            justify-content: center;
            align-items: center;
            margin-top: 0px;
            padding: 0px;
            background-color: red;
            border-radius: 0px;
            position: relative;
        }

        .container {
            width: 90%;
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #E3E3E3;
            border-radius: 12px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .stats-panel {
            display: flex;
            justify-content: space-around;
            background-color: #A6D2FF;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 500;
            border-left: 5px solid #007bff;
        }
        .stats-panel p { margin: 0; }
        .stats-panel span { font-weight: 700; color: #d9534f; }
        #net-wpm, #accuracy { color: #5cb85c; }

        .graph-container {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            height: 350px;
            background-color:#A6D2FF;
        }

        /* --- NEW: News Meta Data Style --- */
        .news-metadata {
            text-align: center;
            background-color: #333;
            color: #fff;
            padding: 8px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            font-size: 0.9em;
            display: none; /* Hidden by default */
        }
        .news-metadata span { color: #fbbc05; font-weight: bold; }

        .typing-text-display {
            background-color: #ADFF5C;
            padding: 25px;
            border-radius: 8px; /* Adjusted if news header is present */
            font-size: 1.4em;
            line-height: 1.8;
            margin-bottom: 20px;      
            height: 2em; 
            overflow: hidden; 
            white-space: nowrap; 
            border: 2px solid #ccc;
            user-select: none;
            scroll-behavior: smooth; 
        }

        .typing-text-display span { display: inline-block; }

        .correct { color: #5cb85c; }
        .incorrect {
            background-color: #f2dede;
            color: #a94442;
            border-bottom: 1px dashed #a94442;
        }
        .current {
            background-color: #007bff40;
            border-right: 2px solid #007bff;
            animation: blink 1s step-start 0s infinite;
        }
        @keyframes blink { 50% { border-right-color: transparent; } }

        .text-input {
            width: 100%;
            height: 100px;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            font-size: 1.4em;
            resize: none;
            background-color: #A6D2FF;
            color: #333;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 20px;
            transition: box-shadow 0.3s;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .controls select, .controls input[type="number"] {
            padding: 10px 18px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
            background-color: #A6D2FF;
            color: #333;
        }

        .loading-text { color: #007bff; font-style: italic; }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .popup-content {
            background: white;
            padding: 0px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 746px;
            height: 430px;
            position: relative;
            overflow:hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }
        .popup-content.show { transform: scale(1); }

        .popup-content h2 { color: #d9534f; font-size: 2.5em; margin-top: 0; }
        .countdown-number {
            font-size: 10em;
            font-weight: 900;
            color: #5cb85c;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .popup-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .popup-time-select {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <main class="glow" style="colour: blue;">

    <header>
        <h1>Typing Speed Pro</h1>
    </header>

<div class="container">
        <div class="stats-panel">
            <p>Net Speed: <span id="net-wpm">0</span> WPM</p>
            <p>Accuracy: <span id="accuracy">100</span>%</p>
            <p>Errors: <span id="errors-count">0</span></p>
            <p>Time Left: <span id="time-left">60</span>s</p>
        </div>

        <div class="graph-container">
            <h3>WPM Consistency (Per 5 seconds)</h3>
            <canvas id="wpm-chart"></canvas>
        </div>

        <div id="initial-controls" class="controls">
            <select id="time-unit" style="width: 120px;">
                <option value="seconds">Seconds</option>
                <option value="minutes">Minutes</option>
            </select>

            <input type="number" id="time-value" min="1" value="60" style="width: 100px;">

            <select id="lesson-mode">
                <option value="news">Dynamic News (Auto-Fetch)</option>
                <option value="standard">Static Paragraph</option>
                <option value="code">Code Syntax</option>
            </select>

            <div class="gradient-border-wrapper">
                <button id="initial-start-btn" class="inner-button" style="background-color: black;">Start Test</button> 
            </div>
        </div>

        <div id="news-metadata" class="news-metadata">
            Topic: <span id="news-topic">Loading...</span> | Date: <span id="news-date">...</span>
        </div>

        <div id="typing-text-display" class="typing-text-display loading-text">
            Loading Fresh Content... Please wait.
        </div>

        <div class="border-wrapper">
            <textarea id="text-input" class="inner-button" style="colour: #D1FFFF; width:100%;" placeholder="Type here when the countdown finishes..." autofocus enhanced></textarea>
        </div> 
</div>
    </main>

    <div id="popup-overlay" class="popup-overlay">
        <div id="popup-content" class="popup-content">
        </div>
    </div>

<script>
    // --- DATA HANDLING ---
    const textBank = {
        standard: "A journey of a thousand miles begins with a single step. The only way to do great work is to love what you do. Success is not final, failure is not fatal: it is the courage to continue that counts.",
        code: "function fetchData(url) { return fetch(url).then(response => response.json()).catch(error => console.error('Error fetching:', error)); }"
    };

    // Store fetched news here
    let newsArticles = [];
    let currentNewsItem = null;

    // --- STATE MANAGEMENT ---
    let state = {
        testText: "", currentCharIndex: 0, totalErrors: 0, correctKeystrokes: 0,
        incorrectKeystrokes: 0, timerId: null, initialTime: 60, timeLeft: 60,
        isRunning: false, wpmHistory: [], historyLabels: [], timeElapsed: 0,
    };

    // --- DOM ELEMENTS ---
    const textDisplay = document.getElementById('typing-text-display');
    const textInput = document.getElementById('text-input');
    const modeSelect = document.getElementById('lesson-mode');
    const timeUnitEl = document.getElementById('time-unit');
    const timeValueEl = document.getElementById('time-value');
    const netWpmEl = document.getElementById('net-wpm');
    const accuracyEl = document.getElementById('accuracy');
    const errorsCountEl = document.getElementById('errors-count');
    const timeLeftEl = document.getElementById('time-left');
    const popupOverlay = document.getElementById('popup-overlay');
    const popupContent = document.getElementById('popup-content');
    const initialStartBtn = document.getElementById('initial-start-btn');
    const newsMetadata = document.getElementById('news-metadata');
    const newsTopic = document.getElementById('news-topic');
    const newsDate = document.getElementById('news-date');

    // --- CHART SETUP ---
    const ctx = document.getElementById('wpm-chart').getContext('2d');
    const wpmChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Net WPM', data: [], borderColor: '#007bff', backgroundColor: '#007bff40', borderWidth: 2, tension: 0.4, fill: true }] },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // --- FETCH NEWS FUNCTION (NEW) ---
    async function fetchNewsData() {
        try {
            // '2.json' is generated by your GitHub Action
            const response = await fetch('2.json'); 
            if (!response.ok) throw new Error("File not found");
            const data = await response.json();
            
            // Filter out short/bad news
            newsArticles = data.filter(item => item.content && item.content.length > 50);
            
            console.log("News loaded:", newsArticles.length);
            // Refresh text if we are currently in news mode
            if (modeSelect.value === 'news') loadText();
        } catch (error) {
            console.error("Failed to load news:", error);
            // Fallback content if file not found
            newsArticles = [{
                title: "Connection Error",
                date: new Date().toISOString().split('T')[0],
                content: "Could not load the latest news from 2.json. Please check your internet connection or ensure the file exists in the repository. In the meantime, you can practice with this placeholder text."
            }];
            if (modeSelect.value === 'news') loadText();
        }
    }

    // --- LOAD TEXT FUNCTION (UPDATED) ---
    function loadText() {
        const mode = modeSelect.value;
        let content = "";

        // Hide news metadata by default
        newsMetadata.style.display = 'none';

        if (mode === 'news') {
            if (newsArticles.length > 0) {
                // Pick random news
                currentNewsItem = newsArticles[Math.floor(Math.random() * newsArticles.length)];
                content = currentNewsItem.content;
                
                // Show Metadata
                newsMetadata.style.display = 'block';
                newsTopic.innerText = currentNewsItem.title.substring(0, 60) + (currentNewsItem.title.length > 60 ? "..." : "");
                newsDate.innerText = currentNewsItem.date;
            } else {
                content = "Loading latest news... Please wait.";
                // Try fetching again if empty
                fetchNewsData();
            }
        } else {
            content = textBank[mode];
        }

        if (content) {
            textDisplay.classList.remove('loading-text');
            state.testText = content.replace(/\s+/g, ' '); // Clean extra spaces
            textDisplay.innerHTML = '';
            state.testText.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.innerHTML = char === ' ' ? '&nbsp;' : char;
                if (index === 0) span.classList.add('current');
                textDisplay.appendChild(span);
            });
            textDisplay.scrollLeft = 0;
        }
    }

    function syncTimeAndReset() {
        const unit = timeUnitEl.value;
        let val = parseInt(timeValueEl.value) || 0;

        if (unit === "minutes" && val > 10) val = 10;
        if (unit === "seconds" && val > 600) val = 600;
        timeValueEl.value = val;

        let totalSeconds = (unit === "minutes") ? val * 60 : val;
        if (totalSeconds < 5) totalSeconds = 5;

        state.initialTime = totalSeconds;
        state.timeLeft = totalSeconds;
        timeLeftEl.textContent = totalSeconds;

        if(!state.isRunning) {
            netWpmEl.textContent = '0';
            accuracyEl.textContent = '100';
            errorsCountEl.textContent = '0';
        }
    }

    function startCountdown() {
        if (state.timerId) clearInterval(state.timerId);

        state.currentCharIndex = 0;
        state.totalErrors = 0;
        state.correctKeystrokes = 0;
        state.incorrectKeystrokes = 0;
        state.timeElapsed = 0;
        state.wpmHistory = [];
        state.historyLabels = [];
        textInput.value = '';
        textInput.disabled = true;
        textInput.style.pointerEvents = "none";

        let count = 3;
        popupOverlay.style.display = 'flex';
        popupContent.classList.add('show');

        const countdownInterval = setInterval(() => {
            if (count > 0) {
                popupContent.innerHTML = `<div class="countdown-number">${count}</div>`;
            } else if (count === 0) {
                popupContent.innerHTML = `<div class="countdown-number">GO!</div>`;
            } else {
                clearInterval(countdownInterval);
                initialStartBtn.textContent = "New Test";
                startTest();
            }
            count--;
        }, 1000);
    }

    function startTest() {
        popupOverlay.style.display = 'none';
        state.isRunning = true;
        textInput.disabled = false;
        textInput.style.pointerEvents = "auto";
        textInput.focus();

        wpmChart.data.labels = [];
        wpmChart.data.datasets[0].data = [];
        wpmChart.update();

        state.timerId = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        if (state.timeLeft > 0) {
            state.timeLeft--;
            timeLeftEl.textContent = state.timeLeft;
            updateMetrics();
        } else {
            clearInterval(state.timerId);
            state.isRunning = false;
            textInput.disabled = true;
            textInput.style.pointerEvents = "none";
            showResultsPopup();
        }
    }

    function updateMetrics() {
        state.timeElapsed = state.initialTime - state.timeLeft;
        const mins = state.timeElapsed / 60;
        let netWPM = mins > 0 ? ((state.correctKeystrokes / 5) - state.totalErrors) / mins : 0;
        netWPM = Math.max(0, Math.round(netWPM));

        netWpmEl.textContent = netWPM;
        const total = state.correctKeystrokes + state.incorrectKeystrokes;
        accuracyEl.textContent = total > 0 ? Math.round((state.correctKeystrokes / total) * 100) : 100;
        errorsCountEl.textContent = state.totalErrors;

        if (state.timeElapsed % 5 === 0 && state.timeElapsed > 0) {
            state.wpmHistory.push(netWPM);
            state.historyLabels.push(state.timeElapsed);
            wpmChart.data.labels = state.historyLabels;
            wpmChart.data.datasets[0].data = state.wpmHistory;
            wpmChart.update();
        }
    }

    function handleInput(event) {
        if (!state.isRunning) return;
        const spans = textDisplay.querySelectorAll('span');
        const typedValue = textInput.value;
        const targetChar = state.testText[state.currentCharIndex];

        if (event.inputType === 'deleteContentBackward') {
            if (state.currentCharIndex > 0) {
                state.currentCharIndex--;
                spans[state.currentCharIndex].className = 'current';
                if (spans[state.currentCharIndex + 1]) spans[state.currentCharIndex + 1].className = '';
            }
            return;
        }

        if (typedValue[typedValue.length - 1] === targetChar) {
            spans[state.currentCharIndex].className = 'correct';
            state.correctKeystrokes++;
        } else {
            spans[state.currentCharIndex].className = 'incorrect';
            state.totalErrors++;
            state.incorrectKeystrokes++;
        }

        state.currentCharIndex++;
        if (state.currentCharIndex >= state.testText.length) {
            state.timeLeft = 0;
            updateTimer();
        } else {
            spans[state.currentCharIndex].className = 'current';
            if (state.currentCharIndex > 20) textDisplay.scrollLeft = spans[state.currentCharIndex].offsetLeft - 200;
        }
    }

    function showResultsPopup() {
        const BACKGROUND_IMAGE_URL = 'Time.png'; // Ensure this image exists
        popupContent.innerHTML = `
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('${BACKGROUND_IMAGE_URL}'); background-size: cover; background-position: center; opacity: 0.8; z-index: 5;"></div>
            <div style="position: relative; z-index: 10; width: 100%; height: 100%; color: #333; padding: 10px;">
                <div class="result-stats" style="position: absolute; background-color: white; border: 3px solid #129612; border-radius:15px; bottom: 6%; right: 10%; font-size: 1.2em; text-align: center; width: 25%;">
                    <p>Net WPM: <span style="color: #5cb85c;">${netWpmEl.textContent}</span></p>
                    <p>Accuracy: <span style="color: #5cb85c;">${accuracyEl.textContent}%</span></p>
                    <p>Errors: <span style="color: #d9534f;">${state.totalErrors}</span></p>
                </div>
                <div class="popup-controls" style="position: absolute; bottom: 8%; left: 20%; transform: translateX(-50%);">
                    <button id="popup-restart-btn" style="color:#14FF99; background-color:#129612; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer;">Restart Test</button> 
                    <div class="popup-time-select" style="border:3px solid #129612; border-radius: 10px; overflow:hidden; background:white; display: flex; margin-top:10px;">
                        <select id="popup-time-unit" style="border:none; padding:8px; outline:none;">
                            <option value="seconds">Sec</option>
                            <option value="minutes">Min</option>
                        </select>
                        <input type="number" id="popup-time-value" min="1" style="border:none; border-left:1px solid #129612; width:70px; padding:8px; outline:none;">
                    </div>
                </div>
            </div>
        `;

        const pUnit = document.getElementById('popup-time-unit');
        const pValue = document.getElementById('popup-time-value');
        pUnit.value = timeUnitEl.value;
        pValue.value = timeValueEl.value;

        document.getElementById('popup-restart-btn').onclick = () => {
            timeUnitEl.value = pUnit.value;
            timeValueEl.value = pValue.value;
            syncTimeAndReset();
            startCountdown();
        };

        popupOverlay.style.display = 'flex';
        popupContent.classList.add('show');
    }

    // --- EVENT LISTENERS ---
    textInput.addEventListener('input', handleInput);
    initialStartBtn.addEventListener('click', () => {
        syncTimeAndReset();
        startCountdown();
    });
    modeSelect.addEventListener('change', loadText);

    // --- INITIALIZATION ---
    window.onload = () => {
        timeUnitEl.value = "minutes";
        timeValueEl.value = "1";
        textInput.disabled = true;
        textInput.style.pointerEvents = "none";
        
        // Start fetching news immediately
        fetchNewsData(); 
        loadText(); // Initial load
        syncTimeAndReset();
    };
</script>
</body>
</html>